---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="Additive Checker - PurelyHealthyFoods">
  <div class="max-w-3xl mx-auto px-4 py-16">
    <a href="/tools" class="text-gray-500 hover:text-primary mb-4 inline-block">&larr; Back to Tools</a>
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Food Additive Checker</h1>
    
    <div class="bg-white shadow-xl rounded-3xl p-8 border border-orange-100">
      <p class="mb-6 text-gray-600">Enter an E-number (e.g., E102) or additive name to check its safety status based on Open Food Facts data.</p>
      
      <div class="flex gap-4 mb-8">
        <input 
          type="text" 
          id="additive-input"
          class="flex-1 rounded-2xl border-orange-100 shadow-sm focus:border-primary focus:ring-primary h-14 px-6 border text-lg" 
          placeholder="E.g. E621 or MSG" 
        />
        <button 
          id="check-btn"
          class="bg-primary text-white px-8 rounded-2xl font-bold hover:bg-green-800 transition-colors shadow-md flex items-center gap-2"
        >
          Check
          <div id="loading-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
        </button>
      </div>

      <!-- Results Container -->
      <div id="results-container" class="hidden border-t pt-8 animate-in fade-in slide-in-from-top-4 duration-500">
        <!-- Result content will be injected here -->
      </div>

      <div class="border-t pt-8 mt-8">
        <h3 class="font-bold text-secondary mb-4">Popular Checks</h3>
        <div class="flex flex-wrap gap-2" id="popular-checks">
          {['E621', 'E951', 'E102', 'Lactic acid', 'Citric acid'].map(item => (
            <button class="px-4 py-2 bg-orange-50 hover:bg-orange-100 rounded-full text-sm text-secondary font-medium transition-colors cursor-pointer border border-orange-100">
              {item}
            </button>
          ))}
        </div>
      </div>
    </div>

    <!-- Data Source Attribution -->
    <p class="mt-8 text-center text-xs text-gray-400">
      Data provided by <a href="https://world.openfoodfacts.org/" target="_blank" class="underline hover:text-primary">Open Food Facts</a>. 
      Evaluation based on EFSA standards where available.
    </p>
  </div>

  <script>
    let additivesData = null;
    const input = document.getElementById('additive-input') as HTMLInputElement;
    const btn = document.getElementById('check-btn');
    const resultsContainer = document.getElementById('results-container');
    const spinner = document.getElementById('loading-spinner');
    const popularBtns = document.getElementById('popular-checks')?.querySelectorAll('button');

    async function fetchData() {
      if (additivesData) return additivesData;
      
      spinner?.classList.remove('hidden');
      try {
        const response = await fetch('https://static.openfoodfacts.org/data/taxonomies/additives.json');
        additivesData = await response.json();
        return additivesData;
      } catch (error) {
        console.error('Error fetching additives data:', error);
        return null;
      } finally {
        spinner?.classList.add('hidden');
      }
    }

    function getRiskInfo(risk: string | undefined) {
      switch (risk?.toLowerCase()) {
        case 'high':
          return { label: 'High Risk', color: 'bg-red-100 text-red-800 border-red-200', icon: '‚ö†Ô∏è' };
        case 'moderate':
          return { label: 'Moderate Risk', color: 'bg-yellow-100 text-yellow-800 border-yellow-200', icon: 'üü°' };
        case 'low':
          return { label: 'Low Risk / Generally Safe', color: 'bg-green-100 text-green-800 border-green-200', icon: '‚úÖ' };
        default:
          return { label: 'Safe / Low Risk', color: 'bg-green-100 text-green-800 border-green-200', icon: '‚úÖ' };
      }
    }

    function search() {
      const query = input.value.trim().toLowerCase();
      if (!query || !additivesData) return;

      let found = null;
      let foundKey = null;

      // Search by key (e.g., en:e102) or E-number
      for (const [key, data] of Object.entries(additivesData)) {
        const eNum = (data as any).e_number?.en?.toLowerCase();
        const name = (data as any).name?.en?.toLowerCase();
        
        if (key.toLowerCase().includes(query) || 
            (eNum && eNum === query.replace(/^e/, '')) || 
            (name && name.includes(query))) {
          found = data;
          foundKey = key;
          break;
        }
      }

      renderResult(found);
    }

    function renderResult(data: any) {
      if (!resultsContainer) return;
      resultsContainer.classList.remove('hidden');

      if (!data) {
        resultsContainer.innerHTML = `
          <div class="bg-gray-50 p-6 rounded-2xl text-center">
            <p class="text-gray-600 font-medium">No results found for "${input.value}".</p>
            <p class="text-sm text-gray-400 mt-1">Try a different E-number or name.</p>
          </div>
        `;
        return;
      }

      const risk = getRiskInfo(data.efsa_evaluation_overexposure_risk?.en);
      const name = data.name?.en || 'Unknown Additive';
      const description = data.description?.en || 'No detailed description available in the database.';
      const vegan = data.vegan?.en || 'Unknown';
      const vegetarian = data.vegetarian?.en || 'Unknown';

      resultsContainer.innerHTML = `
        <div class="space-y-6">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
              <h2 class="text-2xl font-serif font-bold text-secondary">${name}</h2>
              <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded mt-1 inline-block uppercase tracking-wider text-gray-500">
                ${data.e_number?.en ? 'E' + data.e_number.en : 'Additive'}
              </span>
            </div>
            <div class="${risk.color} px-4 py-2 rounded-xl border font-bold flex items-center gap-2 self-start md:self-center shadow-sm">
              <span>${risk.icon}</span>
              ${risk.label}
            </div>
          </div>

          <div class="bg-beige/30 p-6 rounded-2xl border border-orange-50">
            <h4 class="text-sm font-bold text-secondary mb-2 uppercase tracking-tight">Overview</h4>
            <p class="text-gray-700 leading-relaxed">${description}</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-white rounded-2xl border border-orange-100 flex items-center gap-3">
              <span class="text-xl">${vegan === 'yes' ? 'üå±' : '‚ùì'}</span>
              <div>
                <p class="text-xs text-gray-400 font-bold uppercase">Vegan</p>
                <p class="text-secondary font-medium">${vegan.charAt(0).toUpperCase() + vegan.slice(1)}</p>
              </div>
            </div>
            <div class="p-4 bg-white rounded-2xl border border-orange-100 flex items-center gap-3">
              <span class="text-xl">${vegetarian === 'yes' ? 'ü•ó' : '‚ùì'}</span>
              <div>
                <p class="text-xs text-gray-400 font-bold uppercase">Vegetarian</p>
                <p class="text-secondary font-medium">${vegetarian.charAt(0).toUpperCase() + vegetarian.slice(1)}</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Initial fetch
    fetchData();

    btn?.addEventListener('click', () => search());
    input?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') search();
    });

    popularBtns?.forEach(pBtn => {
      pBtn.addEventListener('click', () => {
        input.value = pBtn.textContent?.trim() || '';
        search();
      });
    });
  </script>
</Layout>
